<!doctype html>

<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Колесо стройности — мини‑игра</title>
  <meta name="color-scheme" content="light only"/>
  <style>
    :root{
      --r:#CF2C02;
      --y:#FFBA08;
      --o:#E85D04;
      --txt:#1a1a1a;
      --ok:#18a957;
      --err:#c02626;
    }
    body{margin:0; font-family:Inter,Arial; display:flex; justify-content:center; align-items:center; height:100vh; background:#fff8e1}
    .app{position:relative; width:90vw; max-width:900px}
    .logo{position:absolute; top:10px; right:10px; width:100px}
    .wheel-box{position:relative; width:400px; aspect-ratio:1/1; margin:auto}
    .wheel{position:absolute; inset:0; border-radius:50%; border:8px solid #fff; box-shadow:0 8px 24px rgba(0,0,0,.08); --spin:0deg; --R:0px;}
    .wheel::after{content:""; position:absolute; inset:0; margin:auto; width:22%; aspect-ratio:1/1; border-radius:50%; background:#ffd66d; border:4px solid #fff}
    .slot{position:absolute; inset:0}
    .slot img{position:absolute; left:50%; top:50%; width:60px; transform:translate(-50%,-50%) translate(0,calc(-1*var(--R))) rotate(calc(-1*(var(--deg)+var(--spin))));}
    .pointer{position:absolute; top:-20px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:14px solid transparent; border-right:14px solid transparent; border-bottom:20px solid var(--r)}
    .msg{text-align:center; margin:10px 0;}
    button{display:block; margin:10px auto; padding:10px 20px; background:var(--y); border:0; border-radius:20px; font-weight:700; cursor:pointer}
    .result{text-align:center; margin-top:20px}
  </style>
</head>
<body>
  <div class="app">
    <img src="logo.png" class="logo"/>
    <div class="wheel-box">
      <div class="pointer"></div>
      <div id="wheel" class="wheel"></div>
    </div>
    <div id="msg" class="msg">Нажмите «Вращать», чтобы запустить колесо.</div>
    <button id="btn">Вращать</button>
    <div class="result">
      <img id="resultImg" style="display:none;max-width:150px"/>
      <div id="resultText"></div>
    </div>
  </div><audio id="winSound" src="win.mp3"></audio> <audio id="loseSound" src="lose.mp3"></audio>

  <script>
    const UNSAFE=['bug.png','bug1.png','bug2.png','bug3.png','bug4.png','bug5.png','bug6.png','bug7.png','bug8.png','bug9.png','burger.png'];
    const SAFE=['chicken.png'];
    let ORDER=[];
    const wheel=document.getElementById('wheel');
    const btn=document.getElementById('btn');
    const msg=document.getElementById('msg');
    const resultImg=document.getElementById('resultImg');
    const resultText=document.getElementById('resultText');

    let state="idle", angle=0, speed=0, rafId;

    function shuffle(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];}return array;}

    function buildSlots(){
      ORDER=[...UNSAFE];
      // добавляем курочку с вероятностью 20%
      if(Math.random()<0.2) ORDER.push('chicken.png'); else ORDER.push(UNSAFE[Math.floor(Math.random()*UNSAFE.length)]);
      ORDER=shuffle(ORDER);
      const R=Math.round((wheel.offsetWidth||360)*0.38);
      wheel.style.setProperty('--R',R+'px');
      wheel.innerHTML="";
      ORDER.forEach((file,i)=>{
        const slot=document.createElement('div');
        slot.className='slot';
        slot.style.setProperty('--deg',(i*30)+'deg');
        const img=document.createElement('img');
        img.src=file;
        slot.appendChild(img);
        wheel.appendChild(slot);
      });
    }

    function startSpin(){
      if(state!=='idle'&&state!=='result')return;
      buildSlots();
      resultImg.style.display='none'; resultText.textContent="";
      speed=720; state='spinning'; btn.disabled=true; msg.textContent='Колесо крутится…';
      setTimeout(()=>{state='wait'; btn.disabled=false; btn.textContent='Остановить'; msg.innerHTML='Остановите колесо!';},900);
      spinLoop();
    }

    function spinLoop(){let last=performance.now(); cancelAnimationFrame(rafId);
      function frame(now){const dt=(now-last)/1000; last=now; angle=(angle+speed*dt)%360; applyRotation(); if(state==='spinning')speed=Math.max(360,speed-100*dt); rafId=requestAnimationFrame(frame);} rafId=requestAnimationFrame(frame);}

    function applyRotation(){wheel.style.transform=`rotate(${angle}deg)`; wheel.style.setProperty('--spin',angle+'deg');}

    function stopSpin(){if(state!=='wait')return; state='result'; btn.disabled=true; msg.textContent='Останавливаем…';
      const t0=performance.now(),duration=1100,startSpeed=speed,startAngle=angle; cancelAnimationFrame(rafId);
      function ease(x){return 1-Math.pow(1-x,3)};
      function frame(now){const p=Math.min(1,(now-t0)/duration); angle=startAngle+startSpeed*(1-Math.pow(1-p,3))*0.8; applyRotation(); if(p<1)requestAnimationFrame(frame); else onStopped();} requestAnimationFrame(frame);}

    function angleToIndex(a){const deg=((a%360)+360)%360; return Math.floor((((360-deg)+15)%360)/30);}

    function onStopped(){const idx=angleToIndex(angle); const file=ORDER[idx]; showResult(file); btn.disabled=false; btn.textContent='Сыграть ещё'; msg.textContent='Нажмите «Вращать», чтобы запустить колесо.';}

    function vibrate(ms){if(navigator.vibrate)navigator.vibrate(ms);}

    function showResult(file){resultImg.src=file; resultImg.style.display='block';
      if(file==='burger.png'){resultText.textContent='Ой! Шаман Галина разозлилась!'; document.getElementById('loseSound').play(); vibrate(400);}
      else if(file==='chicken.png'){resultText.textContent='Поздравляем! Амулет ваш!'; document.getElementById('winSound').play(); vibrate([200,100,200]);}
      else{resultText.textContent='Несъедобное…'; document.getElementById('loseSound').play(); vibrate(300);}}

    btn.addEventListener('click',()=>{if(state==='idle'||state==='result'){btn.textContent='Крутится…'; startSpin();} else if(state==='spinning'||state==='wait'){stopSpin();}});

    window.addEventListener('resize',buildSlots);
    buildSlots();
  </script></body>
</html>
