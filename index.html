<!doctype html>

<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Колесо стройности — мини‑игра</title>
  <meta name="color-scheme" content="light only"/>
  <style>
    :root{
      /* Брендовые цвета ШАГАЙ ДОМА */
      --r:#CF2C02; /* кораллово‑красный */
      --y:#FFBA08; /* ярко‑жёлтый */
      --o:#E85D04; /* оранжевый */
      --g:#D9D9D9; /* светло‑серый */
      --txt:#1a1a1a;
      --ok:#18a957;
      --err:#c02626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Color Emoji", "Apple Color Emoji";
      color:var(--txt); background:linear-gradient(180deg,#fff, #fff8e1 35%, #fff3d1);
      display:flex; align-items:center; justify-content:center;
    }
    .app{width:min(920px,96vw); padding:24px; position:relative}/* ЛОГО в правом верхнем углу */
.logo{position:fixed; top:10px; right:10px; width:min(22vw,120px); aspect-ratio:1/1; z-index:1000; pointer-events:none}
.logo img{width:100%; height:100%; object-fit:contain; filter:drop-shadow(0 2px 6px rgba(0,0,0,.08))}
.logo.left{left:10px; right:auto}

.card{
  background:#fff; border:1px solid #fff1c1; border-radius:20px; padding:18px;
  box-shadow:0 6px 22px rgba(0,0,0,.06);
}

.title{font-weight:800; font-size:clamp(22px,4vw,32px); letter-spacing:0.2px;}
.subtitle{margin-top:4px; color:#444; font-size:clamp(14px,2.5vw,16px)}

.playground{display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px}
@media (min-width:840px){ .playground{grid-template-columns: 1.1fr .9fr} }

.wheel-wrap{display:grid; place-items:center; padding:10px}
.wheel-box{position:relative; width:min(72vw,420px); aspect-ratio:1/1;}

/* КОЛЕСО С СЕГМЕНТАМИ И ИКОНКАМИ */
.wheel{
  position:absolute; inset:0; border-radius:50%;
  /* 12 сегментов по 30°: чередуем цвета бренда */
  background:
    conic-gradient(
      from -15deg,
      var(--y) 0deg 30deg,
      var(--o) 30deg 60deg,
      var(--y) 60deg 90deg,
      var(--o) 90deg 120deg,
      var(--y) 120deg 150deg,
      var(--o) 150deg 180deg,
      var(--y) 180deg 210deg,
      var(--o) 210deg 240deg,
      var(--y) 240deg 270deg,
      var(--o) 270deg 300deg,
      var(--y) 300deg 330deg,
      var(--o) 330deg 360deg
    );
  border:8px solid #fff; box-shadow: inset 0 0 0 10px rgba(0,0,0,.04), 0 8px 24px rgba(0,0,0,.08);
  --spin: 0deg; /* текущий угол вращения для контр‑поворота иконок */
  --R: 0px;     /* радиус выкладки иконок (задаём из JS) */
}

.wheel::after{
  /* центр */
  content:""; position:absolute; inset:0; margin:auto; width:22%; aspect-ratio:1/1; border-radius:50%;
  background:radial-gradient(#fff, #ffe6a8 55%, #ffd66d);
  border:4px solid #fff; box-shadow:0 4px 12px rgba(0,0,0,.15);
}

/* Указатель сверху */
.pointer{
  position:absolute; top:-10px; left:50%; transform:translateX(-50%);
  width:0; height:0; border-left:14px solid transparent; border-right:14px solid transparent; border-bottom:20px solid var(--r);
  filter: drop-shadow(0 4px 6px rgba(0,0,0,.18));
  z-index:5;
}

/* Слоты с иконками вокруг колеса */
.slot{ position:absolute; inset:0; transform-origin:50% 50%; }
$1transform: translate(-50%, -50%) rotate(var(--deg)) translate(0, calc(-1 * var(--R))) rotate(calc(-1 * (var(--deg) + var(--spin))));$3

.controls{display:grid; gap:10px; margin-top:8px; position:relative; z-index:2}
.msg{min-height:44px; display:flex; align-items:center; justify-content:center; text-align:center; padding:8px 12px; border-radius:12px; background:#fff8d8; border:1px solid #ffe5a3}
.msg b{color:var(--o)}
.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; user-select:none;
  background:linear-gradient(180deg, var(--y), #ffc43a 40%, #ffb60f);
  color:#3a2a00; font-weight:800; letter-spacing:.3px; text-transform:uppercase; padding:14px 18px;
  border:0; border-radius:999px; box-shadow: 0 10px 18px rgba(233,147,0,.28), 0 3px 0 #eaa200 inset;
  transition: transform .08s ease;
}
.btn:active{ transform: translateY(1px) }
.btn[disabled]{ opacity:.55; cursor:not-allowed }

.result{display:grid; gap:12px}
.result .thumb{ width:min(56vw,280px); aspect-ratio:1/1; border-radius:18px; border:8px solid #fff; box-shadow:0 6px 22px rgba(0,0,0,.12); overflow:hidden; background:#fff; display:grid; place-items:center}
.result .thumb img{ width:100%; height:100%; object-fit:contain; }
.result .text{ font-size:clamp(15px,2.7vw,18px); }

.amulet-bar{ margin-top:10px; display:flex; align-items:center; gap:16px; padding:12px 14px; border-radius:16px; background:linear-gradient(180deg,#fffdf3,#fff9df); border:2px dashed #ffc84a; box-shadow:0 8px 18px rgba(0,0,0,.06) }
.amulet{ width:88px; height:88px; border-radius:16px; background:#fff; border:3px solid #ffd27a; display:grid; place-items:center; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,.08) }
.amulet img{ width:92%; height:92%; object-fit:contain; filter:drop-shadow(0 2px 2px rgba(0,0,0,.12)) }
.amulet.locked img{ filter: grayscale(.92) opacity(.5) }
.ok{ color:var(--ok); font-weight:700 }
.err{ color:var(--err); font-weight:700 }

.hint{ font-size:12px; color:#666; }

.toast{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%); padding:10px 14px; border-radius:12px; background: #101010; color:#fff; box-shadow: 0 12px 24px rgba(0,0,0,.25); opacity:0; pointer-events:none; transition: opacity .25s ease }
.toast.show{ opacity:1 }

/* ====== AMULET MODAL (zoom) ====== */
.amul-modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:2000 }
.amul-modal.open{ display:grid; animation:amulFade .18s ease-out }
@keyframes amulFade{ from{opacity:0} to{opacity:1} }
.amul-modal__content{ position:relative; background:linear-gradient(180deg,#fffdf6,#fff8dc); padding:18px; border-radius:18px; box-shadow:0 20px 50px rgba(0,0,0,.35); border:2px solid #ffe29e }
.amul-modal__content img{ width:min(80vw,380px); height:auto; display:block }
.amul-close{ position:absolute; top:10px; right:10px; font-size:22px; line-height:1; background:#fff; border:1px solid #ffe29e; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; cursor:pointer }
/* === overrides & fixes === */
:root{ --logo-h:0px; }
.app{ padding:calc(24px + var(--logo-h)) 24px 24px; }
.wheel{ z-index:0; overflow:visible; }
.wheel::before, .wheel::after{ z-index:0; }
.slot{ z-index:1; }

  </style>
</head>
<body>
  <div class="app">
    <!-- ЛОГО -->
    <div id="brandLogo" class="logo" aria-label="Логотип">
      <img src="logo.png" alt="ШАГАЙ ДОМА — логотип"/>
    </div><div class="card">
  <div class="title">Колесо стройности</div>
  <div class="subtitle">Вращайте колесо. <b>Остановите на съедобном</b> — и получите амулет!</div>

  <div class="playground">
    <!-- Левая колонка: колесо -->
    <div class="wheel-wrap">
      <div class="wheel-box">
        <div id="pointer" class="pointer" aria-hidden="true"></div>
        <div id="wheel" class="wheel" aria-hidden="true"></div>
      </div>

      <div class="controls">
        <div id="msg" class="msg">Нажмите «Вращать», чтобы запустить колесо удачи.</div>
        <button id="btn" class="btn">Вращать</button>
      </div>

      <div class="amulet-bar">
        <div id="amuletCell" class="amulet locked"><img src="amulet.png" alt="амулет"></div>
        <div>
          <div id="amuletStatus">Амулет на сегодня ещё <span class="err">не получен</span>.</div>
          <div id="amuletHint" class="hint">Поймайте съедобное — и амулет будет ваш. Ограничение: 1 в день.</div>
        </div>
      </div>
    </div>

    <!-- Правая колонка: результат -->
    <div id="resultWrap" class="result">
      <div class="thumb" id="resultThumb" aria-live="polite" aria-atomic="true">
        <img id="resultImg" alt="Результат" src="" style="display:none"/>
        <div id="thumbPlaceholder" style="opacity:.6; font-weight:700; text-align:center; padding:20px;">
          Результат появится здесь
        </div>
      </div>
      <div id="resultText" class="text"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="amuletModal" class="amul-modal" aria-hidden="true">
  <div class="amul-modal__content" role="dialog" aria-modal="true" aria-label="Увеличенный амулет">
    <button class="amul-close" type="button" aria-label="Закрыть">×</button>
    <img src="amulet.png" alt="Амулет крупно" />
  </div>
</div>

  </div>  <script>
    /* =====================
       Настройки игры
    ======================*/
    const UNSAFE = [
      'bug.png','bug1.png','bug2.png','bug3.png','bug4.png','bug5.png','bug6.png','bug7.png','bug8.png','bug9.png','burger.png'
    ];
    const SAFE = ['chicken.png'];
    const ORDER = [...UNSAFE, ...SAFE]; // 12 сегментов (11 несъедобных + 1 съедобный)
    let layout = [...ORDER];
    const LOGO_CORNER = 'right'; // поменяйте на 'left', чтобы перенести логотип в левый верхний угол // текущая раскладка (перемешивается каждый раунд)

    const MESSAGES = {
      start: 'Нажмите «Вращать», чтобы запустить колесо удачи.',
      stopCall: 'Остановите колесо на <b>съедобном</b>, чтобы получить амулет!',
      thinking: 'Колесо крутится…',
      stopped: 'Колесо остановлено. Смотрим результат…'
    };

    /* Ограничение амулета: 1 в день (по локальной дате) */
    const LS_KEY = 'sd_amulet_claimed_on_v1';
    const todayStr = () => new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD

    function amuletClaimedToday(){
      try{ return localStorage.getItem(LS_KEY) === todayStr(); }catch(e){ return false }
    }
    function setAmuletClaimed(){
      try{ localStorage.setItem(LS_KEY, todayStr()); }catch(e){}
    }

    /* =====================
       DOM ссылки
    ======================*/
    const wheel = document.getElementById('wheel');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const resultImg = document.getElementById('resultImg');
    const resultText = document.getElementById('resultText');
    const thumbPh = document.getElementById('thumbPlaceholder');
    const resultWrap = document.getElementById('resultWrap');
    const amuletCell = document.getElementById('amuletCell');
    const amuletStatus = document.getElementById('amuletStatus');
    const amuletHint = document.getElementById('amuletHint');
    const toast = document.getElementById('toast');
    const amuletModal = document.getElementById('amuletModal');
    const amulCloseBtn = amuletModal ? amuletModal.querySelector('.amul-close') : null;
    function openAmuletModal(){
      if (!amuletClaimedToday()){ showToast('Сначала поймайте амулет'); return; }
      if (amuletModal) amuletModal.classList.add('open');
    }
    function closeAmuletModal(){ if (amuletModal) amuletModal.classList.remove('open'); }

    /* =====================
       Стейт-машина
    ======================*/
    const STATE = { IDLE:'IDLE', SPINNING:'SPINNING', WAITING_STOP:'WAITING_STOP', RESULT:'RESULT'};
    let state = STATE.IDLE;

    // Параметры анимации
    let rafId = 0; let angle = 0; let speed = 0; // deg/s

    function setState(newState){ state = newState; }
    function setMsg(html){ msg.innerHTML = html; }
    function showToast(text, ms=1600){
      toast.textContent = text; toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), ms);
    }

    function updateAmuletBar(){
      if (amuletClaimedToday()){
        amuletCell.classList.remove('locked');
        amuletStatus.innerHTML = 'Амулет на сегодня уже <span class="ok">получен</span>!';
        amuletHint.textContent = `Можно играть дальше для удовольствия. Возвращайтесь завтра за новым амулетом.`;
      } else {
        amuletCell.classList.add('locked');
        amuletStatus.innerHTML = 'Амулет на сегодня ещё <span class="err">не получен</span>.';
        amuletHint.textContent = 'Поймайте съедобное — и амулет будет ваш. Ограничение: 1 в день.';
      }
    }

    function preloadImages(paths){ paths.forEach(src=>{ const im=new Image(); im.src=src; }); }
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    /* Рисуем иконки по кругу — сразу видны пользователю */
    function buildSlots(){
      // радиус выкладки = 38% от диаметра
      const size = wheel.offsetWidth || 360;
      const R = Math.round(size * 0.38);
      wheel.style.setProperty('--R', R + 'px');

      // очистить старые слоты (если ресайз)
      [...wheel.querySelectorAll('.slot')].forEach(n=>n.remove());

      layout.forEach((file, i)=>{
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.style.setProperty('--deg', (i*30) + 'deg'); // 12 сегментов

        const img = document.createElement('img');
        img.src = file; img.alt = file.replace('.png','');
        slot.appendChild(img);
        wheel.appendChild(slot);
      });
    }

    function startSpin(){
      if (state !== STATE.IDLE && state !== STATE.RESULT) return;
      // новая раскладка перед каждым раундом
      layout = shuffle([...ORDER]);
      buildSlots();
      angle = 0; applyWheelRotation();
      // скрываем блок результата до остановки
      if (resultWrap) resultWrap.style.display = 'none';
      // сброс результата
      resultImg.style.display='none'; resultImg.removeAttribute('src'); resultText.textContent=''; thumbPh.style.display='grid';
      // стартовая скорость
      speed = 720; // deg / sec
      setState(STATE.SPINNING);
      btn.disabled = true; btn.textContent = 'Крутится…'; setMsg(MESSAGES.thinking);
      // плавный разгон и показ подсказки «Остановите…»
      setTimeout(()=>{
        setState(STATE.WAITING_STOP);
        btn.disabled = false; btn.textContent = 'Остановить'; setMsg(MESSAGES.stopCall);
      }, 900);
      spinLoop();
    }

    function spinLoop(){
      let last = performance.now();
      cancelAnimationFrame(rafId);
      function frame(now){
        const dt = (now - last)/1000; last = now;
        angle = (angle + speed * dt) % 360;
        applyWheelRotation();
        // естественное лёгкое замедление
        if (state === STATE.SPINNING) speed = Math.max(360, speed - 100*dt); // до 360 deg/s
        rafId = requestAnimationFrame(frame);
      }
      rafId = requestAnimationFrame(frame);
    }

    function applyWheelRotation(){
      wheel.style.transform = `rotate(${angle}deg)`;
      wheel.style.setProperty('--spin', angle + 'deg'); // для контр‑поворота иконок
    }

    function stopSpinAndResolve(){
      if (state !== STATE.WAITING_STOP) return;
      setState(STATE.RESULT);
      btn.disabled = true; btn.textContent = 'Останавливаем…'; setMsg(MESSAGES.stopped);

      // Выбор целевого результата с весами: 20% курочка, 80% любой несъедобный
      const pickFile = (Math.random() < 0.20) ? 'chicken.png' : UNSAFE[Math.floor(Math.random()*UNSAFE.length)];
      const targetIndex = layout.indexOf(pickFile);

      // рассчитываем конечный угол так, чтобы под указателем оказался центр целевого сектора
      const current = angle;
      const currentDeg = ((current % 360)+360)%360;
      const centerDeg = (360 - (targetIndex*30)) % 360;
      const deltaToCenter = (centerDeg - currentDeg + 360) % 360;
      const extraSpins = 720; // +2 оборота для красоты
      const finalAngle = current + extraSpins + deltaToCenter;

      cancelAnimationFrame(rafId);
      const t0 = performance.now();
      const duration = 1200;
      function easeOutCubic(x){ return 1 - Math.pow(1 - x, 3) }
      function frame(now){
        const p = Math.min(1, (now - t0)/duration);
        const eased = easeOutCubic(p);
        angle = current + (finalAngle - current) * eased;
        applyWheelRotation();
        if (p < 1){ requestAnimationFrame(frame); } else { onForcedStopResult(pickFile); }
      }
      requestAnimationFrame(frame);
    }

    function onForcedStopResult(file){
      // вибрация и звук при остановке
      try{ if (navigator.vibrate) navigator.vibrate(60); }catch(e){}
      try{ new Audio('stop.mp3').play().catch(()=>{}); }catch(e){}

      showResult(file);
      btn.disabled = false; btn.textContent = 'Сыграть ещё'; setMsg(MESSAGES.start);
      setState(STATE.RESULT);
    }

    function angleToIndex(a){
      const deg = ((a % 360) + 360) % 360;
      const idx = Math.floor((((360 - deg) + 15) % 360) / 30);
      return idx; // 0..11
    }

    function showResult(file){
      if (resultWrap) resultWrap.style.display = 'grid';
      thumbPh.style.display='none';
      resultImg.src = file; resultImg.alt = 'Выпало: ' + file; resultImg.style.display='block';

      if (file === 'burger.png'){
        resultText.innerHTML = '<b style="color:var(--err)">Ой!</b> Шаман Галина увидела ваш ответ и сильно разозлилась!<br>Нет‑нет. Такое мы на нашем острове стройности не едим!';
        showToast('Бургер — несъедобное для острова');
      } else if (file === 'chicken.png'){
        if (!amuletClaimedToday()){
          setAmuletClaimed();
          updateAmuletBar();
          resultText.innerHTML = '<b class="ok">Поздравляем!</b> Это съедобное. Амулет ваш!';
          pulseAmulet();
          confettiLite();
          try{ if (navigator.vibrate) navigator.vibrate([30,40,30]); }catch(e){}
          try{ new Audio('win.mp3').play().catch(()=>{}); }catch(e){}
        } else {
          resultText.innerHTML = 'Это съедобное, но лимит амулетов на сегодня уже исчерпан. Приходите завтра!';
          showToast('Амулет уже получен сегодня');
        }
      } else {
        resultText.textContent = 'Несъедобное… Попробуйте ещё раз!';
        showToast('Увы, не съедобное');
      }
    }

    function pulseAmulet(){
      amuletCell.animate([
        { transform:'scale(1)', boxShadow:'0 0 0 0 rgba(255,186,8,0)', filter:'drop-shadow(0 0 0 rgba(0,0,0,0))' },
        { transform:'scale(1.25)', boxShadow:'0 0 0 12px rgba(255,186,8,.35)', filter:'drop-shadow(0 10px 18px rgba(0,0,0,.2))' },
        { transform:'scale(1)', boxShadow:'0 0 0 0 rgba(255,186,8,0)', filter:'drop-shadow(0 0 0 rgba(0,0,0,0))' }
      ], { duration:900, easing:'cubic-bezier(.2,.9,.2,1)' });
    },
        { transform:'scale(1.12)', filter:'drop-shadow(0 8px 16px rgba(0,0,0,.18))' },
        { transform:'scale(1)' }
      ], { duration:700, easing:'cubic-bezier(.2,.9,.2,1)' });
    }

    /* Мини‑конфетти без зависимостей */
    function confettiLite(){
      const n = 18; const box = document.body; const frags = [];
      for (let i=0;i<n;i++){
        const s = document.createElement('span');
        s.style.cssText = `position:fixed; width:8px; height:12px; left:${50+ (Math.random()*20-10)}vw; top:10vh; background:${i%2? 'var(--y)':'var(--o)'}; transform: rotate(${Math.random()*360}deg); border-radius:2px; z-index:9999;`;
        box.appendChild(s); frags.push(s);
        const dx = (Math.random()*2-1)*30; const dy = 60 + Math.random()*40; const rt = (Math.random()*2-1)*360;
        s.animate([
          { transform:`translate(0,0) rotate(0deg)`, opacity:1 },
          { transform:`translate(${dx}vw, ${dy}vh) rotate(${rt}deg)`, opacity:0 }
        ], { duration:1200 + Math.random()*600, easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish = ()=> s.remove();
      }
    }

    /* Кнопка: два шага — крутить → остановить */
    btn.addEventListener('click', ()=>{
      if (state === STATE.IDLE || state === STATE.RESULT){ startSpin(); return; }
      if (state === STATE.SPINNING || state === STATE.WAITING_STOP){ stopSpinAndResolve(); return; }
    });

    // Поддержка Enter/Space
    document.addEventListener('keydown',(e)=>{
      if (e.code==='Space' || e.code==='Enter'){ e.preventDefault(); btn.click(); }
    });
    // При ресайзе пересчитываем радиус и перерисовываем слоты
    window.addEventListener('resize', ()=>{ buildSlots(); });

    // === Modal events ===
    amuletCell.addEventListener('click', openAmuletModal);
    if (amulCloseBtn) amulCloseBtn.addEventListener('click', closeAmuletModal);
    if (amuletModal){ amuletModal.addEventListener('click', (e)=>{ if (e.target === amuletModal) closeAmuletModal(); }); }
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeAmuletModal(); });

    // Инициализация
    (function init(){
      setMsg(MESSAGES.start);
      updateAmuletBar();
      preloadImages(['amulet.png','logo.png', ...ORDER, 'stop.mp3', 'win.mp3']);
      layout = shuffle([...ORDER]);
      buildSlots();
      if (resultWrap) resultWrap.style.display = 'none';
      const logoEl = document.getElementById('brandLogo');
      if (logoEl) logoEl.classList.toggle('left', LOGO_CORNER === 'left');
      function updateLogoPad(){
        const h = logoEl ? logoEl.offsetHeight : 0;
        document.documentElement.style.setProperty('--logo-h', (h ? h + 16 : 0) + 'px');
      }
      updateLogoPad();
      window.addEventListener('resize', updateLogoPad);
      const logoImg = logoEl ? logoEl.querySelector('img') : null;
      if (logoImg && !logoImg.complete) logoImg.addEventListener('load', updateLogoPad);
    })();
  </script>
</body>
</html>
